# Pre-commit hooks for automated code quality enforcement
# Install with: pip install pre-commit && pre-commit install

repos:
  # Code formatting
  - repo: https://github.com/psf/black
    rev: 25.1.0
    hooks:
      - id: black
        language_version: python3

  # Import sorting
  - repo: https://github.com/pycqa/isort
    rev: 6.0.1
    hooks:
      - id: isort
        args: ["--profile", "black"]

  # Linting and style checks
  - repo: https://github.com/pycqa/flake8
    rev: 7.3.0
    hooks:
      - id: flake8

  # General file checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-toml
      - id: check-merge-conflict
      - id: check-added-large-files
      - id: check-docstring-first

  # Python-specific checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: debug-statements
      - id: name-tests-test
        args: [--pytest-test-first]

  # Import validation (custom hook)
  - repo: local
    hooks:
      - id: validate-imports
        name: validate-imports
        entry: |
          python -c "
          import sys
          import importlib.util
          import ast

          def check_imports(filename):
              try:
                  with open(filename, 'r') as f:
                      tree = ast.parse(f.read())

                  # Extract imports
                  imports = []
                  for node in ast.walk(tree):
                      if isinstance(node, ast.ImportFrom):
                          if node.module and node.module.startswith('verskyt'):
                              for alias in node.names:
                                  imports.append((node.module, alias.name))

                  # Check that imports can be resolved
                  for module, name in imports:
                      try:
                          mod = importlib.import_module(module)
                          if not hasattr(mod, name):
                              print(f'ERROR: {filename}: {module} does not export {name}')
                              return False
                      except ImportError as e:
                          print(f'ERROR: {filename}: Cannot import {module}: {e}')
                          return False
                  return True
              except Exception as e:
                  print(f'ERROR: {filename}: Failed to parse: {e}')
                  return False

          if __name__ == '__main__':
              success = all(check_imports(f) for f in sys.argv[1:])
              sys.exit(0 if success else 1)
          "
        language: system
        files: \.py$
        stages: [pre-commit]

  # Root directory cleanliness check
  - repo: local
    hooks:
      - id: check-root-pollution
        name: check-root-pollution
        entry: |
          python -c "
          import sys
          import glob
          import os

          # Check for common debug/test file patterns in root
          patterns = ['debug_*.py', 'test_new_*.py', '*_scratch.py', 'tmp_*.py', 'temp_*.py']
          found_files = []

          for pattern in patterns:
              matches = glob.glob(pattern)
              found_files.extend(matches)

          if found_files:
              print('ERROR: Development artifacts found in root directory:')
              for f in found_files:
                  print(f'  - {f}')
              print('Solution: Move to debug/ subdirectory or delete temporary files')
              sys.exit(1)

          print('âœ… Root directory clean')
          "
        language: system
        pass_filenames: false
        stages: [pre-commit]

  # Basic test validation
  - repo: local
    hooks:
      - id: basic-tests
        name: basic-tests
        entry: pytest tests/ -x --tb=short
        language: system
        pass_filenames: false
        stages: [pre-push]  # Only run on push, not every commit
